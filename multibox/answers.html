<!DOCTYPE html> 
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Antworten speichern und drucken</title>
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            box-sizing: border-box;
        }

        .quill-editor {
            height: 150px;
            margin-bottom: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .button-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        button {
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 4px;
        }

        #saveBtn {
            background-color: #008CBA;
        }

        #clearBtn {
            background-color: #f44336;
        }

        #downloadAllBtn {
            background-color: #555555;
            padding: 6px 12px;
            font-size: 12px;
        }

        .info-text {
            font-style: italic;
            color: #555;
            margin-bottom: 20px;
        }

        /* Save Indicator */
        #saveIndicator {
            display: none;
            color: #4CAF50;
            font-size: 12px;
            margin-bottom: 10px;
            padding: 4px 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #4CAF50;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            body.print-single #printContent,
            body.print-single #printContent * {
                visibility: visible;
            }

            body.print-all #printAllContent,
            body.print-all #printAllContent * {
                visibility: visible;
            }

            #printContent, #printAllContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .quill-editor {
                display: none;
            }

            pre {
                white-space: pre-wrap;
                font-size: 14px;
                padding: 10px;
                box-sizing: border-box;
                width: 100%;
                height: auto;
                margin-bottom: 20px;
                border: none;
            }

            #printAllContent .draft {
                border: none;
                padding: 0;
                margin-bottom: 20px;
            }

            #printAllContent .draft h3 {
                margin-bottom: 5px;
            }

            button {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div id="printContent">
        <div id="saveIndicator">Gespeichert ✓</div>
        <p id="assignmentInfo"></p>
        <div id="answerBox" class="quill-editor"></div>
        <pre id="answerText" style="display: none;"></pre>
    </div>

    <p class="info-text">
        Sie können diese einzelne Antwort hier herunterladen oder alle Antworten für diese Einheit am Ende der Einheit herunterladen.
    </p>

    <div class="button-container">
        <button id="saveBtn" onclick="saveToLocal()">Antwort zwischenspeichern</button>
        <button id="downloadAllBtn">Alle Antworten drucken / Als PDF speichern</button>
    </div>

    <div class="button-container" style="margin-top: 10px;">
        <button id="clearBtn" onclick="clearLocalStorage()">Alle Antworten löschen</button>
    </div>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const assignmentId = getQueryParam('assignmentId') || 'defaultAssignment';
        const assignmentInfo = document.getElementById('assignmentInfo');
        const assignmentSuffix = assignmentId.replace(/^assignment[_-]?/, '');
        assignmentInfo.textContent = assignmentSuffix ? `Auftrag: ${assignmentSuffix}` : 'Auftrag';

        const quill = new Quill('#answerBox', {
            theme: 'snow',
            placeholder: 'Gib hier deine Antworten ein...',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });

        const saveIndicator = document.getElementById('saveIndicator');

        function saveToLocal() {
            const htmlContent = quill.root.innerHTML;
            const textContent = quill.getText().trim();
            if (textContent === "") return;
            
            try {
                localStorage.setItem(assignmentId, htmlContent);
                showSaveIndicator();
            } catch (e) {
                console.error("Fehler beim Speichern:", e);
            }
        }

        function showSaveIndicator() {
            saveIndicator.style.display = 'block';
            setTimeout(() => {
                saveIndicator.style.display = 'none';
            }, 1000);
        }

        function clearLocalStorage() {
            if (confirm("Alle Antworten löschen?")) {
                localStorage.clear();
                quill.setText('');
            }
        }

        const debouncedSave = debounce(saveToLocal, 2000);
        quill.on('text-change', (delta, oldDelta, source) => {
            if (source === 'user') debouncedSave();
        });

        const savedText = localStorage.getItem(assignmentId);
        if (savedText) quill.root.innerHTML = savedText;

        document.getElementById("downloadAllBtn").addEventListener('click', function() {
            const storageKeys = Object.keys(localStorage).filter(key => key.startsWith('assignment'));
            if(storageKeys.length === 0) return;

            const printAllContent = document.createElement('div');
            printAllContent.id = 'printAllContent';

            storageKeys.sort((a, b) => {
                const suffixA = a.replace(/^assignment[_-]?/, '');
                const suffixB = b.replace(/^assignment[_-]?/, '');
                return suffixA.localeCompare(suffixB, undefined, {numeric: true, sensitivity: 'base'});
            });

            storageKeys.forEach(assignmentKey => {
                const text = localStorage.getItem(assignmentKey);
                if(text) {
                    const draftDiv = document.createElement("div");
                    draftDiv.className = "draft";
                    const assignmentSuffix = assignmentKey.replace(/^assignment[_-]?/, '');
                    const title = document.createElement("h3");
                    title.textContent = assignmentSuffix ? `Auftrag: ${assignmentSuffix}` : 'Auftrag';
                    draftDiv.appendChild(title);
                    draftDiv.innerHTML += text;
                    printAllContent.appendChild(draftDiv);
                }
            });

            document.body.appendChild(printAllContent);
            document.body.classList.add('print-all');
            window.print();
            document.body.classList.remove('print-all');
            document.body.removeChild(printAllContent);
        });

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>
</body>
</html>
