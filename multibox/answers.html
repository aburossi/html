<!DOCTYPE html> 

<html lang="de">

<head>

    <meta charset="UTF-8">

    <title>Antworten speichern und drucken</title>

    <style>

        body {

            font-family: Arial, sans-serif;

            padding: 10px;

            box-sizing: border-box;

        }

        textarea {

            width: 100%;

            height: 150px;

            margin-bottom: 10px;

            resize: vertical;

            padding: 10px;

            font-size: 14px;

            box-sizing: border-box;

        }

        button {

            padding: 8px 16px;

            font-size: 14px;

            cursor: pointer;

            margin-right: 10px;

            margin-top: 10px;

            color: white;

            border: none;

            border-radius: 4px;

        }

        #printBtn {

            background-color: #4CAF50; /* Grün */

        }

        #saveBtn {

            background-color: #008CBA; /* Blau */

        }

        #clearBtn {

            background-color: #f44336; /* Rot */

        }

        #downloadAllBtn {

            background-color: #555555; /* Dunkelgrau */

        }

        .info-text {

            font-size: 12px;

            color: #555;

            margin-bottom: 10px;

        }

        #draftContainer {

            margin-top: 20px;

        }

        .draft {

            margin-bottom: 20px;

            border: 1px solid #ccc;

            padding: 15px;

            border-radius: 5px;

        }

        .draft h3 {

            margin-bottom: 5px;

        }

        .draft textarea {

            width: 100%;

            height: 100px;

            resize: vertical;

            padding: 10px;

            font-size: 14px;

            box-sizing: border-box;

            margin-bottom: 10px;

        }

        @media print {

            body * {

                visibility: hidden;

            }

            /* Make both #printContent and #printAllContent visible */

            #printContent, #printContent *,

            #printAllContent, #printAllContent * {

                visibility: visible;

            }

            /* Position the printContent and printAllContent at the top-left corner */

            #printContent, #printAllContent {

                position: absolute;

                left: 0;

                top: 0;

                width: 100%;

            }

            textarea {

                display: none;

            }

            #answerText, .draft pre {

                display: block;

                white-space: pre-wrap; /* Zeilenumbrüche beibehalten */

                font-size: 14px;

                padding: 10px;

                border: 1px solid #ccc;

                box-sizing: border-box;

                width: 100%;

                height: auto;

            }

            /* Additional styling for #printAllContent */

            #printAllContent .draft h3 {

                margin-bottom: 10px;

            }

            #printAllContent pre {

                white-space: pre-wrap; /* Zeilenumbrüche beibehalten */

                font-size: 14px;

                padding: 10px;

                border: 1px solid #ccc;

                box-sizing: border-box;

                width: 100%;

                height: auto;

                margin-bottom: 20px;

            }

            /* Hide all buttons during print */

            button {

                display: none;

            }

        }

    </style>

</head>

<body>

    <!-- Bereich für das Drucken einer einzelnen Antwort -->

    <div id="printContent">

        <h3>Deine Antwort:</h3>

        <p id="assignmentInfo"></p>

        <textarea id="answerBox" placeholder="Gib hier deine Antworten ein..."></textarea>

        <pre id="answerText" style="display: none;"></pre>

    </div>

    

    <p class="info-text">

        Mit "Antwort zwischenspeichern" werden deine Antworten auf einer Seite gespeichert, die am Ende der Einheit angezeigt wird.

    </p>

    <button id="printBtn" onclick="printAnswer()">Antwort drucken / als PDF speichern</button>

    <button id="saveBtn" onclick="saveToLocal()">Antwort zwischenspeichern</button>

    <button id="clearBtn" onclick="clearLocalStorage()">Alle Antworten löschen</button>

    

    <br><br>

    

    <!-- Hinzufügen der "Alle Antworten drucken / Als PDF speichern" Funktion -->

    <button id="downloadAllBtn">Alle Antworten drucken / Als PDF speichern</button>

    

    <div id="draftContainer">

        <!-- Gespeicherte Antworten werden hier geladen -->

    </div>

    

    <script>

        // Funktion zum Abrufen eines Query-Parameters nach Name

        function getQueryParam(param) {

            const urlParams = new URLSearchParams(window.location.search);

            return urlParams.get(param);

        }



        const assignmentId = getQueryParam('assignmentId') || 'defaultAssignment';

        const assignmentInfo = document.getElementById('assignmentInfo');



        // Extrahiere die numerische Komponente der assignmentId

        const assignmentNumberMatch = assignmentId.match(/\d+/);

        const assignmentNumber = assignmentNumberMatch ? assignmentNumberMatch[0] : '';

        assignmentInfo.textContent = assignmentNumber ? `Auftrag ${assignmentNumber}` : 'Auftrag';



        const textarea = document.getElementById('answerBox');

        const answerText = document.getElementById('answerText');



        // Lade gespeicherten Text aus localStorage

        const savedText = localStorage.getItem(assignmentId);

        if (savedText) {

            textarea.value = savedText;

            console.log(`Geladener gespeicherter Text für ${assignmentId}`);

        } else {

            console.log(`Kein gespeicherter Text für ${assignmentId} gefunden`);

        }



        // Funktion zum Drucken der Antwort

        function printAnswer() {

            const text = textarea.value;

            if (text.trim() === "") {

                alert("Das Antwortfeld ist leer. Bitte geben Sie eine Antwort ein.");

                console.log("Druckversuch mit leerem Textfeld");

                return;

            }

            // Setze den Text für den Druck

            answerText.textContent = text;

            console.log(`Druckvorgang für ${assignmentId} gestartet`);

            window.print();

            // Verzögertes Löschen des Textes, um sicherzustellen, dass der Druckvorgang abgeschlossen ist

            setTimeout(() => { answerText.textContent = ''; }, 1000);

        }



        // Funktion zum Zwischenspeichern der Antwort in localStorage

        function saveToLocal() {

            const text = textarea.value;

            if (text.trim() === "") {

                alert("Das Antwortfeld ist leer. Bitte geben Sie eine Antwort ein.");

                console.log("Speicherversuch mit leerem Textfeld");

                return;

            }

            localStorage.setItem(assignmentId, text);

            alert("Antwort zwischengespeichert.");

            console.log(`Text für ${assignmentId} gespeichert`);

            loadAllAnswers(); // Aktualisiere die Liste der gespeicherten Antworten

        }



        // Funktion zum Löschen aller gespeicherten Antworten aus localStorage

        function clearLocalStorage() {

            if (confirm("Sind Sie sicher, dass Sie alle gespeicherten Antworten löschen möchten?")) {

                localStorage.clear();

                textarea.value = '';

                alert("Alle gespeicherten Antworten wurden gelöscht.");

                console.log("Alle localStorage-Elemente gelöscht");

                loadAllAnswers(); // Aktualisiere die Liste der gespeicherten Antworten

            }

        }



        // Funktion zum Laden und Anzeigen aller gespeicherten Antworten

        function loadAllAnswers() {

            const draftContainer = document.getElementById("draftContainer");

            draftContainer.innerHTML = ""; // Leere den Container



            const storageKeys = Object.keys(localStorage).filter(key => key.startsWith('assignment'));



            console.log(`Gefundene ${storageKeys.length} gespeicherte Aufträge`);



            if(storageKeys.length === 0) {

                draftContainer.innerHTML = "<p>Keine gespeicherten Antworten gefunden.</p>";

                return;

            }



            // Sortiere die storageKeys basierend auf der numerischen Komponente

            storageKeys.sort((a, b) => {

                const numA = parseInt(a.replace('assignment', ''), 10);

                const numB = parseInt(b.replace('assignment', ''), 10);

                return numA - numB;

            });



            console.log("Sortierte Auftrag-IDs:", storageKeys);



            storageKeys.forEach(assignmentKey => {

                const text = localStorage.getItem(assignmentKey);

                if(text) {

                    console.log(`Lade Auftrag: ${assignmentKey}`);

                    const draftDiv = document.createElement("div");

                    draftDiv.className = "draft";

                    

                    const title = document.createElement("h3");

                    title.textContent = "Gespeicherte Antwort für " + assignmentKey.replace('assignment', 'Auftrag ');

                    draftDiv.appendChild(title);

                    

                    const pre = document.createElement("pre");

                    pre.textContent = text;

                    draftDiv.appendChild(pre);

                    

                    draftContainer.appendChild(draftDiv);

                }

            });

        }



        // Initiales Laden aller gespeicherten Antworten beim Laden der Seite

        document.addEventListener("DOMContentLoaded", function() {

            loadAllAnswers();



            // Add event listener for Print All Answers button

            const downloadAllBtn = document.getElementById("downloadAllBtn");

            downloadAllBtn.addEventListener('click', function() {

                const storageKeys = Object.keys(localStorage).filter(key => key.startsWith('assignment'));



                console.log(`Gefundene ${storageKeys.length} gespeicherte Aufträge zum Drucken`);



                if(storageKeys.length === 0) {

                    alert("Keine gespeicherten Antworten zum Drucken oder Speichern als PDF.");

                    console.log("Drucken aller Antworten versucht, aber keine gespeichert");

                    return;

                }



                console.log("Drucken aller Antworten initiiert");



                // Erstelle ein temporäres div für das Drucken aller Antworten

                const printAllContent = document.createElement('div');

                printAllContent.id = 'printAllContent';



                // Sortiere die storageKeys wie zuvor

                storageKeys.sort((a, b) => {

                    const numA = parseInt(a.replace('assignment', ''), 10);

                    const numB = parseInt(b.replace('assignment', ''), 10);

                    return numA - numB;

                });



                storageKeys.forEach(assignmentKey => {

                    const text = localStorage.getItem(assignmentKey);

                    if(text) {

                        const draftDiv = document.createElement("div");

                        draftDiv.className = "draft";

                        

                        const title = document.createElement("h3");

                        title.textContent = "Gespeicherte Antwort für " + assignmentKey.replace('assignment', 'Auftrag ');

                        draftDiv.appendChild(title);

                        

                        const pre = document.createElement("pre");

                        pre.textContent = text;

                        draftDiv.appendChild(pre);

                        

                        printAllContent.appendChild(draftDiv);

                    }

                });



                // Append to body, print, and then remove

                document.body.appendChild(printAllContent);

                window.print();

                document.body.removeChild(printAllContent);

            });

        });



        // Optional: Logge den initialen Zustand von localStorage zur Fehlerbehebung

        console.log("Initialer Zustand von localStorage:");

        for (let i = 0; i < localStorage.length; i++) {

            const key = localStorage.key(i);

            console.log(`${key}: ${localStorage.getItem(key)}`);

        }

    </script>

</body>

</html>
