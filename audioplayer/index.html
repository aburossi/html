<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Espresso Radio Wave Visualization</title>
    <style>
        /* Basic styles for the canvas and text */
        #waveCanvas {
            border: 1px solid #ccc;
            margin-top: 10px;
            background: #f0f0f0;
        }
        #animatedText {
            font-family: Arial, sans-serif;
            font-size: 24px;
            margin-top: 15px;
            color: #333;
            transition: all 0.1s;
        }
    </style>
</head>
<body>
    <!-- Audio Player -->
    <audio id="audioPlayer" controls preload="auto" crossorigin="anonymous">
        <!-- The source element will be updated via JavaScript -->
        <source src="" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Wave Visualization Canvas -->
    <canvas id="waveCanvas" width="600" height="150"></canvas>
    
    <!-- Animated Text -->
    <div id="animatedText">Now Playing: SRF Espresso Radio</div>

    <script>
        // Get the audio element and other elements from the page
        const audioElement = document.getElementById('audioPlayer');
        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        const textElement = document.getElementById('animatedText');

        // Function to set up and start the audio visualization
        function setupVisualization() {
            // Web Audio API Setup
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaElementSource(audioElement);

            source.connect(analyser);
            analyser.connect(audioContext.destination);
            analyser.fftSize = 512;

            // Buffer for audio data
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            // Animation Loop: draw waveform and animate text
            function drawWaveform() {
                requestAnimationFrame(drawWaveform);
                analyser.getByteTimeDomainData(dataArray);

                // Clear the canvas
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw the waveform
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#2c7da0';
                ctx.beginPath();

                const sliceWidth = canvas.width / bufferLength;
                let x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * canvas.height / 2;
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                    x += sliceWidth;
                }
                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();

                // Animate the text based on the average amplitude
                const average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                textElement.style.transform = `scale(${1 + average / 80}) rotate(${(average - 128) / 20}deg)`;
                textElement.style.color = `hsl(${average * 2}, 70%, 45%)`;
            }

            // Start the animation when audio plays
            audioElement.addEventListener('play', () => {
                audioContext.resume().then(() => {
                    drawWaveform();
                });
            });
        }

        // Function to update the audio source using a JSON file based on the query parameter
        function loadAudioFromJSON() {
            // Get the URL parameter "audioId"
            const params = new URLSearchParams(window.location.search);
            const audioId = params.get('audioId');

            // Determine the JSON file to load; if none provided, you can set a default here
            const jsonFile = audioId ? `${audioId}.json` : 'default.json';

            fetch(jsonFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network error: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.url) {
                        // Update the <source> element with the URL from the JSON file
                        const sourceElement = audioElement.querySelector('source');
                        sourceElement.src = data.url;
                        audioElement.load();  // Reload the audio element with the new source
                        // Optionally update the animated text to reflect the loaded audio
                        textElement.textContent = `Now Playing: ${audioId}`;
                    } else {
                        console.error("JSON file does not contain a 'url' property.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching or parsing JSON:", error);
                });
        }

        // Adjust canvas width on window resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth > 600 ? 600 : window.innerWidth - 20;
        });

        // Load the audio source and then set up visualization
        loadAudioFromJSON();
        setupVisualization();
    </script>
</body>
</html>
